generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums (simplified for Jessica's approach) ---
enum RoleName {
  ADMIN
  DONOR
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
  CARD
}

// --- Core models ---
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  twoFAEnabled Boolean  @default(false)
  twoFASecret  String?
  roles        UserRole[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model UserRole {
  userId   String
  roleName RoleName

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleName])
}

// --- Donations for Jessica's mission ---
model Donation {
  id           String   @id @default(cuid())
  donorId      String?
  donor        Donor?   @relation(fields: [donorId], references: [id])
  amountCents  Int
  currency     String   @default("USD")
  purpose      String?  // General purpose description
  sessionId    String   @unique
  status       String   // 'OPEN' | 'COMPLETE' | 'EXPIRED'
  donationType String   // 'one-time' | 'recurring'
  createdAt    DateTime @default(now())
  completedAt  DateTime?
}

model Donor {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String?
  phone     String?
  country   String?
  createdAt DateTime   @default(now())
  donations Donation[]
}

// --- Public content models (blog & e-learning) ---

model BlogPost {
  id                    String   @id @default(cuid())
  slug                  String   @unique
  title                 String
  summary               String   @db.Text
  contentHtml           String   @db.Text
  contentMarkdown       String?  @db.Text
  author                String
  authorRole            String?
  authorBio             String?  @db.Text
  authorAvatarUrl       String?
  coverImageUrl         String?
  coverConsentVerified  Boolean  @default(false)
  category              String   @default("impact")
  tags                  String[] @default([])
  readMinutes           Int      @default(5)
  excerpt               String?  @db.Text
  calloutTransparency   String?  @db.Text
  relatedSlugs          String[] @default([])
  seoTitle              String?
  seoDescription        String?  @db.Text
  publishedAt           DateTime? @default(now())
  status                String   @default("published")
  views                 Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relation: images uploaded/linked for this post (cover + inline)
  images               BlogImage[]
}

// --- Gallery for Jessica's photos ---
model GalleryImage {
  id          String   @id @default(cuid())
  filename    String
  url         String
  title       String?
  description String?
  category    String   @default("journey") // 'journey' | 'workshop' | 'impact'
  tags        String[] @default([])
  uploadedAt  DateTime @default(now())
  isPublic    Boolean  @default(true)
}

// --- Blog images (cover or inline), stored for audit/transparency ---
model BlogImage {
  id         String    @id @default(cuid())
  postId     String?
  post       BlogPost? @relation(fields: [postId], references: [id], onDelete: SetNull)
  role       String    @default("inline") // 'cover' | 'inline'
  url        String
  filename   String
  alt        String?
  width      Int?
  height     Int?
  uploadedAt DateTime  @default(now())

  @@index([postId])
}
